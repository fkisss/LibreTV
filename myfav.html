<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的自定义收藏 - LibreTV</title>
    <link rel="icon" href="image/logo.png">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/index.css">
    <style>
        .fav-card { background: #191919; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 8px #0002; }
        .fav-card img { width: 100px; height: 140px; object-fit: cover; border-radius: 6px; }
        .fav-card .info { flex: 1; margin-left: 16px; }
        .fav-card .title { font-size: 1.1rem; font-weight: bold; color: #fff; }
        .fav-card .meta { color: #aaa; font-size: 0.95em; margin-top: 4px; }
        .fav-card .desc { color: #ccc; font-size: 0.95em; margin-top: 8px; }
        .fav-card .actions { margin-top: 10px; }
        .fav-card .actions button { margin-right: 8px; }
        .fav-list { max-width: 900px; margin: 0 auto; }
        .fav-header { text-align: center; margin: 32px 0 24px; }
        .fav-header h1 { font-size: 2.2rem; font-weight: bold; }
        .fav-header p { color: #aaa; margin-top: 8px; }
        .fav-source-title { font-size: 1.2rem; color: #ffb6c1; margin: 32px 0 12px; font-weight: bold; }
    </style>
</head>
<body class="page-bg text-white">
    <div class="fav-header">
        <h1>我的自定义收藏</h1>
        <p>自定义你喜欢的资源站和分类，快速浏览和播放</p>
    </div>
    <div id="favList" class="fav-list"></div>

    <!-- 详情模态框 -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
        <div class="bg-[#191919] rounded-lg p-6 max-w-lg w-full relative">
            <button id="closeModal" class="absolute top-2 right-2 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h2 id="modalTitle" class="text-xl font-bold mb-2"></h2>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
// 1. 这里自定义你喜欢的接口和分类
const myFavList = [
    {
        api: 'https://cj.rycjapi.com/api.php/provide/vod',
        name: '如意资源',
        type_id: '47',
        type_name: '动画电影'
    },
    {
        api: 'https://bfzyapi.com/api.php/provide/vod',
        name: '暴风资源',
        type_id: '25',
        type_name: '爱情片'
    }
];

const PROXY_URL = '/proxy/';
const API_CONFIG = {
    detail: {
        path: '?ac=videolist&ids=',
        headers: {
            'User-Agent': 'Mozilla/5.0',
            'Accept': 'application/json'
        }
    }
};

// 2. 加载所有自定义分类下的视频
async function fetchAllFavVideos() {
    const container = document.getElementById('favList');
    container.innerHTML = '';
    for (const fav of myFavList) {
        const list = await fetchCategoryVideos(fav);
        renderFavCategory(container, fav, list);
    }
}

// 3. 获取某个分类下所有视频（自动翻页）
async function fetchCategoryVideos(fav) {
    let page = 1, all = [], pagecount = 1;
    do {
        // 关键：不要encode整个url
        const url = `${PROXY_URL}${fav.api}?ac=videolist&t=${fav.type_id}&pg=${page}`;
        const res = await fetch(url);
        const data = await res.json();
        if (Array.isArray(data.list)) all = all.concat(data.list);
        pagecount = data.pagecount || 1;
        page++;
        if (page > 3) break; // 默认最多取3页，可自行调整
    } while(page <= pagecount);
    return all;
}

// 4. 渲染每个分类下的视频
function renderFavCategory(container, fav, list) {
    const title = document.createElement('div');
    title.className = 'fav-source-title';
    title.textContent = `${fav.name} - ${fav.type_name}（共${list.length}部）`;
    container.appendChild(title);
    if (!list.length) {
        const empty = document.createElement('div');
        empty.textContent = '暂无数据';
        empty.style.color = '#aaa';
        container.appendChild(empty);
        return;
    }
    list.forEach(item => {
        const card = document.createElement('div');
        card.className = 'fav-card flex p-4';
        card.innerHTML = `
            <img src="${item.vod_pic}" onerror="this.src='https://via.placeholder.com/100x140?text=无封面'">
            <div class="info">
                <div class="title">${item.vod_name}</div>
                <div class="meta">${item.type_name || ''} | ${item.vod_year || ''} | ${item.vod_area || ''}</div>
                <div class="desc">${item.vod_remarks || ''}</div>
                <div class="actions">
                    <button onclick="showDetail('${fav.api}','${item.vod_id}','${fav.name.replace(/'/g,'')}','${item.vod_name.replace(/'/g,'')}')" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded">详情/播放</button>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

// 5. 显示详情和播放
async function showDetail(api, vod_id, sourceName, vod_name) {
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    modal.classList.remove('hidden');
    modalTitle.textContent = vod_name + '（' + sourceName + '）';
    modalContent.innerHTML = '加载中...';
    // 获取详情
    const url = `${PROXY_URL}${api}${API_CONFIG.detail.path}${vod_id}`;
    const res = await fetch(url);
    const data = await res.json();
    if (!data.list || !data.list.length) {
        modalContent.innerHTML = '<div style="color:#f66">未找到详情</div>';
        return;
    }
    const info = data.list[0];
    let playUrl = '';
    if (info.vod_play_url) {
        // 取第一个播放源第一个集
        const mainSource = info.vod_play_url.split('$$$')[0];
        playUrl = mainSource.split('#')[0].split('$')[1] || '';
    }
    modalContent.innerHTML = `
        <div style="margin-bottom:10px;">
            <img src="${info.vod_pic}" style="width:120px;height:170px;object-fit:cover;float:left;margin-right:16px;">
            <div><b>类型：</b>${info.type_name || ''}</div>
            <div><b>年份：</b>${info.vod_year || ''}</div>
            <div><b>地区：</b>${info.vod_area || ''}</div>
            <div><b>导演：</b>${info.vod_director || ''}</div>
            <div><b>主演：</b>${info.vod_actor || ''}</div>
            <div><b>简介：</b>${info.vod_content || ''}</div>
        </div>
        <div style="clear:both"></div>
        <div style="margin-top:16px;">
            ${playUrl ? `<button onclick="playVideo('${encodeURIComponent(playUrl)}','${encodeURIComponent(info.vod_name)}')" class="px-4 py-2 bg-pink-600 hover:bg-pink-700 text-white rounded">播放</button>` : '<span style="color:#f66">无播放地址</span>'}
        </div>
    `;
}

// 6. 播放视频（跳转到player.html）
function playVideo(url, title) {
    window.location.href = `player.html?url=${url}&title=${title}`;
}

// 7. 关闭模态框
window.addEventListener('DOMContentLoaded', () => {
    fetchAllFavVideos();
    document.getElementById('closeModal').onclick = () => {
        document.getElementById('modal').classList.add('hidden');
    };
    document.getElementById('modal').onclick = (e) => {
        if (e.target === document.getElementById('modal')) {
            document.getElementById('modal').classList.add('hidden');
        }
    };
});
    </script>
</body>
</html> 